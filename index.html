<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Crystal Beat</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a0a;overflow:hidden;font-family:-apple-system,sans-serif;color:white}
canvas{position:fixed;top:0;left:0}
#menu{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#0a0a0a;padding:30px;z-index:10}
#menu h1{font-size:36px;font-weight:800;margin-bottom:8px}
.btn{padding:16px;border-radius:14px;border:none;font-weight:700;margin-top:10px;width:100%}
.add{background:#1a1a1a;border:2px dashed #333}
.play{background:#1db954}
#fileInput{display:none}
#game-ui{position:fixed;top:0;left:0;right:0;display:none;flex-direction:column;align-items:center;padding:16px;z-index:5}
#score{font-size:28px;font-weight:800;margin-top:10px}
#combo{font-size:13px;opacity:.6}
</style>
</head>
<body>

<canvas id="canvas"></canvas>

<div id="menu">
<h1>Crystal Beat</h1>
<input type="file" id="fileInput" accept="audio/*" multiple>
<button class="btn add" onclick="fileInput.click()">+ Добавить песни</button>
<button class="btn play" id="playBtn" disabled onclick="startGame()">Играть</button>
</div>

<div id="game-ui">
<div id="score">0</div>
<div id="combo"></div>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = innerWidth;
canvas.height = innerHeight;

let songs=[],selectedIndex=-1;
let score=0,combo=0;
let crystals=[],particles=[];
let player={x:canvas.width/2,y:canvas.height-120,size:36,color:'#1db954'};
let gameRunning=false,paused=false;
let audioContext,analyser,sourceNode,dataArray;
let lastBeat=0,energy=0,energyHistory=[];
let animId=null;
let touchX=canvas.width/2;
let baseColor={r:29,g:185,b:84};

fileInput.addEventListener('change',e=>{
const files=[...e.target.files];
files.forEach(file=>{
const url=URL.createObjectURL(file);
songs.push({file,url,name:file.name});
});
if(songs.length>0)selectedIndex=0;
playBtn.disabled=songs.length===0;
});

function randomColorFromName(name){
let hash=0;
for(let i=0;i<name.length;i++)hash=name.charCodeAt(i)+((hash<<5)-hash);
const r=(hash>>16)&255;
const g=(hash>>8)&255;
const b=hash&255;
return{r:Math.abs(r),g:Math.abs(g),b:Math.abs(b)};
}

function startGame(){
if(selectedIndex<0)return;
menu.style.display='none';
gameUI.style.display='flex';
loadAndPlay(selectedIndex);
}

async function loadAndPlay(i){
stopAudio();
if(animId)cancelAnimationFrame(animId);

score=0;combo=0;crystals=[];particles=[];
document.getElementById('score').textContent='0';
document.getElementById('combo').textContent='';

const song=songs[i];
baseColor=randomColorFromName(song.name);
player.color=`rgb(${baseColor.r},${baseColor.g},${baseColor.b})`;

audioContext=new AudioContext();
analyser=audioContext.createAnalyser();
analyser.fftSize=512;
dataArray=new Uint8Array(analyser.frequencyBinCount);

const buffer=await song.file.arrayBuffer();
const audioBuffer=await audioContext.decodeAudioData(buffer);

sourceNode=audioContext.createBufferSource();
sourceNode.buffer=audioBuffer;
sourceNode.connect(analyser);
analyser.connect(audioContext.destination);
sourceNode.start();

gameRunning=true;
gameLoop();
}

function stopAudio(){
try{if(sourceNode)sourceNode.stop()}catch(e){}
try{if(audioContext)audioContext.close()}catch(e){}
}

canvas.addEventListener('touchmove',e=>{touchX=e.touches[0].clientX},{passive:false});
canvas.addEventListener('touchstart',e=>{touchX=e.touches[0].clientX});
window.addEventListener('mousemove',e=>touchX=e.clientX);

function spawnCrystal(){
const x=30+Math.random()*(canvas.width-60);
const size=14+Math.random()*10;
crystals.push({x,y:-size,size,glow:`hsl(${Math.random()*360},100%,70%)`});
}

function spawnParticles(x,y,color){
for(let i=0;i<12;i++){
particles.push({
x,y,
vx:(Math.random()-.5)*6,
vy:(Math.random()-.5)*6,
life:1,
color
});
}
}

function gameLoop(){
if(!gameRunning)return;

analyser.getByteFrequencyData(dataArray);
const bass=dataArray.slice(0,8).reduce((a,b)=>a+b)/8;
energy=bass;

energyHistory.push(bass);
if(energyHistory.length>40)energyHistory.shift();
const avg=energyHistory.reduce((a,b)=>a+b)/energyHistory.length;
const threshold=avg*1.4;

const now=audioContext.currentTime*1000;
const minInterval=Math.max(140,480-energy*1.2);

if(bass>threshold&&now-lastBeat>minInterval){
lastBeat=now;
spawnCrystal();
}

player.x+=(touchX-player.x)*0.2;
player.x=Math.max(player.size,Math.min(canvas.width-player.size,player.x));

ctx.fillStyle=`rgb(${baseColor.r*.08},${baseColor.g*.08},${baseColor.b*.08})`;
ctx.fillRect(0,0,canvas.width,canvas.height);

const pulse=energy/255;
ctx.fillStyle=`rgba(${baseColor.r},${baseColor.g},${baseColor.b},${pulse*.08})`;
ctx.fillRect(0,0,canvas.width,canvas.height);

crystals=crystals.filter(c=>{
c.y+=4+energy*.03;

ctx.save();
ctx.beginPath();
ctx.arc(c.x,c.y,c.size,0,Math.PI*2);
ctx.fillStyle=c.glow;
ctx.shadowColor=c.glow;
ctx.shadowBlur=20;
ctx.fill();
ctx.restore();

const dx=c.x-player.x;
const dy=c.y-player.y;
if(Math.sqrt(dx*dx+dy*dy)<c.size+player.size*.6){
combo++;
score+=100*Math.min(combo,10);
document.getElementById('score').textContent=score;
document.getElementById('combo').textContent=combo>1?combo+'x комбо':'';
spawnParticles(c.x,c.y,c.glow);
return false;
}

if(c.y>canvas.height+30){
combo=0;
document.getElementById('combo').textContent='';
return false;
}
return true;
});

particles=particles.filter(p=>{
p.x+=p.vx;
p.y+=p.vy;
p.life-=.04;
if(p.life<=0)return false;
ctx.save();
ctx.globalAlpha=Math.max(0,p.life);
ctx.beginPath();
ctx.arc(p.x,p.y,5*p.life,0,Math.PI*2);
ctx.fillStyle=p.color;
ctx.fill();
ctx.restore();
return true;
});

ctx.save();
ctx.shadowColor=player.color;
ctx.shadowBlur=15+pulse*20;
ctx.fillStyle=player.color;
ctx.fillRect(player.x-player.size/2,player.y-player.size/2,player.size,player.size);
ctx.restore();

animId=requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>
